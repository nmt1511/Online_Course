@model Online_Course.ViewModels.LearningLessonsViewModel
@using Online_Course.Models
@{
    ViewData["Title"] = "Danh sách bài học - " + Model.CourseTitle;
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
}

@* CSS cho hiệu ứng bài học bị khóa | CSS for lesson locking effects *@
<style>
    .lesson-locked {
        filter: grayscale(1);
        opacity: 0.7;
        cursor: not-allowed !important;
    }
</style>

<!-- Main Content Area | Khu vực nội dung chính -->
<div class="flex flex-1 justify-center py-5 lg:px-40 px-4">
    <div class="flex flex-col max-w-[960px] flex-1 gap-6">
        <!-- Breadcrumbs | Đường dẫn chuyển hướng -->
        <div class="flex flex-wrap items-center gap-2 px-4">
            <a asp-area="Student" asp-controller="Courses" asp-action="Index" class="text-text-secondary text-sm font-medium leading-normal hover:text-primary">Khóa học</a>
            <span class="material-symbols-outlined text-[16px] text-text-secondary">chevron_right</span>
            <a asp-area="Student" asp-controller="Progress" asp-action="Index" class="text-text-secondary text-sm font-medium leading-normal hover:text-primary">Khóa học của tôi</a>
            <span class="material-symbols-outlined text-[16px] text-text-secondary">chevron_right</span>
            <span class="text-slate-900 dark:text-white text-sm font-medium leading-normal">@Model.CourseTitle</span>
        </div>

        <!-- Course Header & Progress | Tiêu đề khóa học và Tiến độ -->
        <div class="flex flex-col gap-6 rounded-xl bg-white dark:bg-surface-dark p-6 shadow-sm border border-border-light dark:border-border-dark">
            <!-- Heading | Tiêu đề -->
            <div class="flex flex-wrap justify-between gap-4 items-start">
                <div class="flex min-w-72 flex-col gap-2">
                    <div class="flex items-center gap-2">
                        <span class="rounded bg-primary/10 px-2 py-0.5 text-xs font-bold text-primary uppercase tracking-wider">@Model.CourseCategoryName</span>
                    </div>
                    <h1 class="text-slate-900 dark:text-white text-3xl md:text-4xl font-black leading-tight tracking-tight">@Model.CourseTitle</h1>
                    <p class="text-text-secondary text-base font-normal">Tiếp tục hành trình học tập của bạn.</p>
                </div>
                
                @* Nút hành động thay đổi theo trạng thái học tập | Action button changes based on learning status *@
                @{
                    string actionText = "Bắt đầu học";
                    string actionIcon = "play_arrow";
                    if (Model.CourseStatus == LearningStatus.IN_PROGRESS)
                    {
                        actionText = "Tiếp tục học";
                        actionIcon = "resume";
                    }
                    else if (Model.CourseStatus == LearningStatus.COMPLETED)
                    {
                        actionText = "Xem lại";
                        actionIcon = "history";
                    }

                    var nextToLearn = Model.Lessons.OrderBy(l => l.OrderIndex).FirstOrDefault(l => !l.IsCompleted && !l.IsLocked) 
                                     ?? Model.Lessons.OrderBy(l => l.OrderIndex).FirstOrDefault();
                }

                @if (nextToLearn != null)
                {
                    <a asp-action="Content" asp-route-lessonId="@nextToLearn.LessonId" class="flex items-center gap-2 cursor-pointer justify-center overflow-hidden rounded-lg h-10 px-6 bg-primary hover:bg-blue-600 text-white text-sm font-bold leading-normal transition-all shadow-lg shadow-blue-500/20">
                        <span class="material-symbols-outlined text-[20px]">@actionIcon</span>
                        <span class="truncate">@actionText</span>
                    </a>
                }
            </div>
            <div class="h-px w-full bg-border-light dark:bg-border-dark"></div>
            
            <!-- Stats & Progress | Thống kê và Tiến độ -->
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-end">
                    <div class="flex flex-col">
                        <p class="text-slate-900 dark:text-white text-base font-bold">Tiến độ hoàn thành</p>
                        <p class="text-text-secondary text-sm">Bạn đã hoàn thành @Model.CompletedLessons/@Model.TotalLessons bài học</p>
                    </div>
                    <p class="text-primary text-xl font-bold">@Model.ProgressPercentage.ToString("0")%</p>
                </div>
                <div class="h-2.5 w-full rounded-full bg-slate-200 dark:bg-border-dark overflow-hidden">
                    <div class="h-full rounded-full bg-primary transition-all duration-500 ease-out" style="width: @Model.ProgressPercentage%"></div>
                </div>
            </div>

            <!-- Mini Stats Grid | Lưới thống kê nhỏ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                <div class="flex flex-col gap-1 p-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark">
                    <div class="flex items-center gap-2 text-text-secondary">
                        <span class="material-symbols-outlined text-[18px]">check_circle</span>
                        <span class="text-xs font-medium uppercase">Đã học</span>
                    </div>
                    <p class="text-slate-900 dark:text-white text-xl font-bold">@Model.CompletedLessons</p>
                </div>
                <div class="flex flex-col gap-1 p-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark">
                    <div class="flex items-center gap-2 text-text-secondary">
                        <span class="material-symbols-outlined text-[18px]">list</span>
                        <span class="text-xs font-medium uppercase">Tổng số</span>
                    </div>
                    <p class="text-slate-900 dark:text-white text-xl font-bold">@Model.TotalLessons</p>
                </div>
                <div class="flex flex-col gap-1 p-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark">
                    <div class="flex items-center gap-2 text-text-secondary">
                        <span class="material-symbols-outlined text-[18px]">schedule</span>
                        <span class="text-xs font-medium uppercase">Còn lại</span>
                    </div>
                    <p class="text-slate-900 dark:text-white text-xl font-bold">@(Model.TotalLessons - Model.CompletedLessons)</p>
                </div>
                <div class="flex flex-col gap-1 p-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark">
                    <div class="flex items-center gap-2 text-text-secondary">
                        <span class="material-symbols-outlined text-[18px]">emoji_events</span>
                        <span class="text-xs font-medium uppercase">Trạng thái</span>
                    </div>
                    <p class="text-slate-900 dark:text-white text-xl font-bold">
                        @* Cập nhật trạng thái hiển thị | Update display status *@
                        @switch (Model.CourseStatus)
                        {
                            case LearningStatus.NOT_STARTED: <span>Chưa học</span> break;
                            case LearningStatus.IN_PROGRESS: <span>Đang học</span> break;
                            case LearningStatus.COMPLETED: <span>Hoàn thành</span> break;
                            default: <span>Chưa học</span> break;
                        }
                    </p>
                </div>
            </div>
        </div>

        <!-- Lesson List Section | Phần danh sách bài học -->
        <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between px-2">
                <h3 class="text-slate-900 dark:text-white text-xl font-bold leading-tight">Nội dung khóa học</h3>
            </div>
            <div class="flex flex-col gap-3">
                @foreach (var lesson in Model.Lessons.OrderBy(l => l.OrderIndex))
                {
                    if (lesson.IsLocked)
                    {
                        <!-- Locked Lesson | Bài học bị khóa -->
                        <div class="lesson-locked group flex flex-col md:flex-row md:items-center gap-4 rounded-xl border border-border-light dark:border-border-dark bg-slate-50 dark:bg-[#151b22] p-4 transition-all cursor-not-allowed"
                             onclick="showConfirmDialog(null, 'Bài học bị khóa', 'Bạn cần hoàn thành bài học trước đó để có thể mở khóa bài học này.', 'Đã hiểu', 'info')">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="flex items-center justify-center rounded-full bg-slate-200 dark:bg-border-dark text-text-secondary size-10 min-w-10">
                                    <span class="material-symbols-outlined text-[20px]">lock</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-text-secondary text-xs font-bold uppercase tracking-wide">Bài @lesson.OrderIndex</span>
                                    </div>
                                    <p class="text-text-secondary font-medium text-lg">@lesson.Title</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between md:justify-end gap-4 md:w-auto w-full border-t md:border-t-0 border-border-light dark:border-border-dark pt-3 md:pt-0">
                                <span class="inline-flex items-center rounded-md bg-gray-100 dark:bg-gray-800 px-2.5 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 ring-1 ring-inset ring-gray-500/10">Bị khóa</span>
                                <span class="flex items-center gap-1 rounded-lg px-3 py-2 text-sm font-bold text-text-secondary">
                                    <span class="material-symbols-outlined text-sm">lock</span>
                                    <span>Chưa mở</span>
                                </span>
                            </div>
                        </div>
                    }
                    else if (lesson.IsCompleted)
                    {
                        <!-- Completed Lesson | Bài học đã hoàn thành -->
                        <a asp-action="Content" asp-route-lessonId="@lesson.LessonId" class="group flex flex-col md:flex-row md:items-center gap-4 rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-surface-dark p-4 hover:border-primary/30 transition-all">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="flex items-center justify-center rounded-full bg-green-500/10 text-green-600 dark:text-green-500 size-10 min-w-10">
                                    <span class="material-symbols-outlined">check</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-text-secondary text-xs font-bold uppercase tracking-wide">Bài @lesson.OrderIndex</span>
                                    </div>
                                    <p class="text-slate-900 dark:text-white font-bold text-lg group-hover:text-primary transition-colors">@lesson.Title</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between md:justify-end gap-4 md:w-auto w-full border-t md:border-t-0 border-border-light dark:border-border-dark pt-3 md:pt-0">
                                <span class="inline-flex items-center rounded-md bg-green-500/10 px-2.5 py-1 text-xs font-medium text-green-600 dark:text-green-500 ring-1 ring-inset ring-green-500/20">Đã hoàn thành</span>
                                <span class="flex items-center gap-1 rounded-lg px-3 py-2 text-sm font-bold text-text-secondary group-hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-sm">history</span>
                                    <span>Xem lại</span>
                                </span>
                            </div>
                        </a>
                    }
                    else
                    {
                        <!-- In Progress / Available Lesson | Bài học đang học hoặc có thể học -->
                        <a asp-action="Content" asp-route-lessonId="@lesson.LessonId" class="relative group flex flex-col md:flex-row md:items-center gap-4 rounded-xl border border-primary bg-white dark:bg-surface-dark p-4 shadow-[0_0_20px_rgba(19,127,236,0.05)] ring-1 ring-primary/20">
                            <div class="absolute -left-[1px] top-4 bottom-4 w-1 bg-primary rounded-r-lg"></div>
                            <div class="flex items-center gap-4 flex-1">
                                <div class="flex items-center justify-center rounded-full bg-primary text-white size-10 min-w-10 shadow-lg shadow-primary/30">
                                    <span class="material-symbols-outlined">play_arrow</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-primary text-xs font-bold uppercase tracking-wide">Bài @lesson.OrderIndex</span>
                                    </div>
                                    <p class="text-slate-900 dark:text-white font-bold text-lg">@lesson.Title</p>
                                    @if (!string.IsNullOrEmpty(lesson.Description))
                                    {
                                        <p class="text-sm text-text-secondary line-clamp-1">@lesson.Description</p>
                                    }
                                </div>
                            </div>
                            <div class="flex items-center justify-between md:justify-end gap-4 md:w-auto w-full border-t md:border-t-0 border-border-light dark:border-border-dark pt-3 md:pt-0">
                                <span class="inline-flex items-center rounded-md bg-primary/10 px-2.5 py-1 text-xs font-medium text-primary ring-1 ring-inset ring-primary/20">Đang học</span>
                                <span class="flex items-center justify-center gap-1 rounded-lg px-5 py-2 text-sm font-bold bg-primary text-white hover:bg-blue-600 transition-colors shadow-sm">
                                    <span class="material-symbols-outlined text-sm">school</span>
                                    <span>Học ngay</span>
                                </span>
                            </div>
                        </a>
                    }
                }
            </div>
        </div>
    </div>
</div>
