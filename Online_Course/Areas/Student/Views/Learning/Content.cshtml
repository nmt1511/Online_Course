@model Online_Course.ViewModels.LearningContentViewModel
@{
    ViewData["Title"] = Model.LessonTitle + " - " + Model.CourseTitle;
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - EduTech</title>
    
    <!-- Google Fonts: Lexend-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <!-- Material Symbols Outline-->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Cấu hình worker cho PDF.js 
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Cấu hình theme -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-dark": "#1a232e",
                        "border-dark": "#283039",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Lexend', sans-serif; }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .dark ::-webkit-scrollbar-track { background: #111418; }
        .dark ::-webkit-scrollbar-thumb { background: #3b4754; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #4b5966; }
        
        /* Hiệu ứng bài học bị khóa | Locked lesson effects */
        .lesson-item-locked {
            opacity: 0.5;
            cursor: not-allowed !important;
        }

        /* Custom PDF Viewer Styles | Kiểu trình xem PDF tùy chỉnh */
        .pdf-canvas {
            max-width: 100%;
            height: auto !important;
        }
        #pdf-scroll-container::-webkit-scrollbar {
            width: 10px;
        }
        #pdf-scroll-container::-webkit-scrollbar-track {
            background: #1e293b;
        }
        #pdf-scroll-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 5px;
        }
    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display overflow-hidden h-screen flex flex-col">

    <!--Thanh điều hướng trên cùng -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 dark:border-border-dark bg-white dark:bg-background-dark px-6 py-3 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <a asp-area="Student" asp-controller="Learning" asp-action="Lessons" asp-route-courseId="@Model.CourseId" class="flex items-center gap-3 text-slate-900 dark:text-white hover:opacity-80 transition-opacity">
                <div class="p-2 rounded-lg bg-primary/10 text-primary">
                    <span class="material-symbols-outlined">school</span>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-base font-bold leading-tight tracking-tight">@Model.CourseTitle</h2>
                    <span class="text-xs text-slate-500 dark:text-slate-400 font-normal">@Model.CourseCategoryName</span>
                </div>
            </a>
        </div>
        <div class="flex items-center gap-6">
            <div class="hidden md:flex items-center gap-6">
                <a asp-area="Student" asp-controller="Courses" asp-action="Index" class="text-slate-600 dark:text-slate-300 text-sm font-medium leading-normal hover:text-primary transition-colors">Khóa học</a>
                <a asp-area="Student" asp-controller="Progress" asp-action="Index" class="text-slate-600 dark:text-slate-300 text-sm font-medium leading-normal hover:text-primary transition-colors">Khóa học của tôi</a>
            </div>
            <div class="h-6 w-px bg-gray-200 dark:bg-border-dark hidden md:block"></div>
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end hidden sm:flex">
                    <span class="text-sm font-bold">@User.Identity?.Name</span>
                    <span class="text-xs text-slate-500">Học viên</span>
                </div>
                <div class="bg-primary/20 rounded-full size-10 border-2 border-transparent hover:border-primary cursor-pointer transition-all flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary">person</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Bố cục chính -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- Thanh bên (Nội dung khóa học) -->
        <aside class="w-80 flex flex-col border-r border-gray-200 dark:border-border-dark bg-white dark:bg-background-dark shrink-0 h-full overflow-hidden absolute md:relative z-10 -translate-x-full md:translate-x-0 transition-transform duration-300" id="courseSidebar">
            <!--Tóm tắt tiến độ -->
            <div class="p-5 border-b border-gray-200 dark:border-border-dark">
                <div class="flex justify-between items-end mb-2">
                    <p class="text-sm font-medium text-slate-700 dark:text-white">Tiến độ khóa học</p>
                    <p class="text-xs font-bold text-primary">@Model.ProgressPercentage.ToString("0")%</p>
                </div>
                <div class="rounded-full bg-gray-200 dark:bg-border-dark h-2 overflow-hidden">
                    <div class="h-full bg-primary rounded-full" style="width: @Model.ProgressPercentage%"></div>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">@Model.CompletedLessons/@Model.TotalLessons Bài học đã hoàn thành</p>
            </div>
            
            <!--Danh sách giáo trình -->
            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                @foreach (var lesson in Model.AllLessons)
                {
                    var isCurrentLesson = lesson.LessonId == Model.LessonId;
                    
                    if (lesson.IsLocked)
                    {
                        @* Bài học bị khóa trong Sidebar | Locked lesson in Sidebar *@
                        <div class="lesson-item-locked flex items-center gap-3 px-3 py-2.5 rounded-lg text-left w-full group transition-all"
                             onclick="showLockAlert()">
                            <span class="material-symbols-outlined text-slate-400 text-[20px] shrink-0">lock</span>
                            <span class="text-sm text-slate-400 font-medium line-clamp-1">@lesson.Title</span>
                        </div>
                    }
                    else if (lesson.IsCompleted)
                    {
                        <a asp-action="Content" asp-route-lessonId="@lesson.LessonId" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-surface-dark group transition-colors text-left w-full @(isCurrentLesson ? "bg-gray-100 dark:bg-surface-dark" : "")">
                            <span class="material-symbols-outlined text-green-500 text-[20px] shrink-0">check_circle</span>
                            <span class="text-sm text-slate-600 dark:text-slate-300 font-medium group-hover:text-primary line-clamp-1 @(isCurrentLesson ? "text-primary" : "")">@lesson.Title</span>
                        </a>
                    }
                    else if (isCurrentLesson)
                    {
                        <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 dark:bg-primary/20 border-l-4 border-primary text-left w-full shadow-sm">
                            <span class="material-symbols-outlined filled text-primary text-[20px] shrink-0">@(lesson.LessonType == Online_Course.Models.LessonType.Video ? "play_circle" : "description")</span>
                            <div class="flex flex-col">
                                <span class="text-sm text-primary font-bold line-clamp-1">@lesson.Title</span>
                                <span class="text-[10px] text-slate-500 dark:text-slate-400">Bài @lesson.OrderIndex</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <a asp-action="Content" asp-route-lessonId="@lesson.LessonId" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-surface-dark group transition-colors text-left w-full">
                            <span class="material-symbols-outlined text-slate-400 text-[20px] shrink-0">@(lesson.LessonType == Online_Course.Models.LessonType.Video ? "play_circle" : "description")</span>
                            <span class="text-sm text-slate-600 dark:text-slate-300 font-medium group-hover:text-primary line-clamp-1">@lesson.Title</span>
                        </a>
                    }
                }
            </div>
        </aside>

        <!--Khu vực nội dung chính -->
        <main class="flex-1 overflow-y-auto bg-gray-50 dark:bg-[#111418] relative scroll-smooth">
            <!-- Nút bật thanh bên di động -->
            <div class="md:hidden p-4 pb-0">
                <button class="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-sm font-medium" onclick="document.getElementById('courseSidebar').classList.toggle('-translate-x-full')">
                    <span class="material-symbols-outlined">menu_open</span>
                    Danh sách bài học
                </button>
            </div>
            
            <div class="max-w-[1000px] mx-auto p-4 md:p-8 flex flex-col gap-6">
                <!--Khung trình phát Video -->
                <div class="flex flex-col gap-4">
                    <div class="relative w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl group">
                        @if (!string.IsNullOrEmpty(Model.ContentUrl))
                        {
                            @if (Model.LessonType == Online_Course.Models.LessonType.Video)
                            {
                                @if (Model.ContentUrl.Contains("youtube.com") || Model.ContentUrl.Contains("youtu.be"))
                                {
                                    var videoId = "";
                                    if (Model.ContentUrl.Contains("youtube.com/watch?v="))
                                    {
                                        videoId = Model.ContentUrl.Split("v=")[1].Split("&")[0];
                                    }
                                    else if (Model.ContentUrl.Contains("youtu.be/"))
                                    {
                                        videoId = Model.ContentUrl.Split("youtu.be/")[1].Split("?")[0];
                                    }
                                    <iframe id="youtube-player" class="absolute inset-0 w-full h-full" src="https://www.youtube.com/embed/@videoId?enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                }
                                else
                                {
                                    <video id="html5-player" class="absolute inset-0 w-full h-full" controls>
                                        <source src="@Model.ContentUrl" type="video/mp4">
                                        Trình duyệt của bạn không hỗ trợ video.
                                    </video>
                                }
                            }
                            else if (Model.LessonType == Online_Course.Models.LessonType.Pdf)
                            {
                                @* Trình xem PDF nội bộ để tránh lỗi CORS trên Localhost *@
                                <div id="pdf-viewer-container" class="absolute inset-0 w-full h-full overflow-hidden flex flex-col bg-[#333]">
                                    <!-- Toolbar -->
                                    <div class="bg-slate-900/90 backdrop-blur text-white p-2 flex justify-between items-center text-xs shrink-0 z-10 border-b border-white/10">
                                        <div class="flex items-center gap-4 ml-2">
                                            <span id="pdf-page-num" class="font-medium">Đang tải tài liệu...</span>
                                        </div>
                                        <div class="flex items-center gap-3 mr-2">
                                            <button onclick="changeZoom(-0.2)" class="p-1.5 hover:bg-white/10 rounded-lg transition-colors">
                                                <span class="material-symbols-outlined text-[18px]">remove_circle</span>
                                            </button>
                                            <span id="pdf-zoom" class="w-10 text-center font-bold">100%</span>
                                            <button onclick="changeZoom(0.2)" class="p-1.5 hover:bg-white/10 rounded-lg transition-colors">
                                                <span class="material-symbols-outlined text-[18px]">add_circle</span>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Scroll Container -->
                                    <div id="pdf-scroll-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                                        <div id="pdf-pages-list" class="flex flex-col items-center gap-6">
                                            @* Canvases will be rendered here *@
                                            <div id="pdf-loader" class="flex flex-col items-center gap-3 py-20">
                                                <div class="size-10 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
                                                <p class="text-slate-400 text-sm">Đang xử lý PDF...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- Hiển thị khi không có nội dung -->
                            <div class="absolute inset-0 flex items-center justify-center bg-slate-800">
                                <div class="text-center">
                                    <span class="material-symbols-outlined text-[64px] text-slate-500">@(Model.LessonType == Online_Course.Models.LessonType.Video ? "videocam_off" : "document_scanner")</span>
                                    <p class="text-slate-400 mt-2">Chưa có nội dung cho bài học này</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Thanh điều hướng và hành động bài học -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 py-2 border-b border-gray-200 dark:border-border-dark pb-6">
                    <div class="flex flex-col gap-1 w-full md:w-auto">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white">Bài @Model.OrderIndex: @Model.LessonTitle</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400">@Model.CourseTitle</p>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                        @if (Model.PreviousLessonId.HasValue)
                        {
                            <a asp-action="Content" asp-route-lessonId="@Model.PreviousLessonId" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark text-slate-700 dark:text-slate-300 text-sm font-medium hover:bg-gray-100 dark:hover:bg-surface-dark transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                                Trước
                            </a>
                        }
                        
                        @if (Model.IsCompleted)
                        {
                            <span class="px-6 py-2 rounded-lg bg-green-500/10 text-green-600 dark:text-green-500 text-sm font-bold flex items-center gap-2 ring-1 ring-green-500/20">
                                <span class="material-symbols-outlined text-[18px]">check_circle</span>
                                <span>Đã học xong</span>
                            </span>
                        }
                        
                        @if (Model.NextLessonId.HasValue)
                        {
                            <a asp-action="Content" asp-route-lessonId="@Model.NextLessonId" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark text-slate-700 dark:text-slate-300 text-sm font-medium hover:bg-gray-100 dark:hover:bg-surface-dark transition-colors flex items-center gap-2">
                                Sau
                                <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                            </a>
                        }
                    </div>
                </div>

                <!-- Nội dung và Thông tin -->
                <div class="flex flex-col gap-6">
                    <!-- Nội dung Tab -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Nội dung văn bản chính -->
                        <div class="lg:col-span-2 space-y-4 text-slate-600 dark:text-slate-300 leading-relaxed">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Nội dung bài học</h3>
                            @if (!string.IsNullOrEmpty(Model.LessonDescription))
                            {
                                <div class="prose dark:prose-invert max-w-none">
                                    @Html.Raw(Model.LessonDescription.Replace("\n", "<br/>"))
                                </div>
                            }
                            else
                            {
                                <p class="text-slate-500 dark:text-slate-400 italic">Chưa có mô tả cho bài học này.</p>
                            }
                        </div>
                        
                        <!-- Thông tin thanh bên / Giảng viên -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-gray-100 dark:border-border-dark shadow-sm">
                                <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-4">Giảng viên</h4>
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="size-12 rounded-full bg-primary/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary">person</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-slate-900 dark:text-white">@Model.InstructorName</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Giảng viên</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-gray-100 dark:border-border-dark shadow-sm">
                                <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-3">Thông tin khóa học</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-slate-500 dark:text-slate-400">Tiến độ</span>
                                        <span class="text-xs font-bold text-primary">@Model.ProgressPercentage.ToString("0")%</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-slate-500 dark:text-slate-400">Bài học</span>
                                        <span class="text-xs font-medium text-slate-700 dark:text-slate-300">@Model.CompletedLessons / @Model.TotalLessons</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-slate-500 dark:text-slate-400">Danh mục</span>
                                        <span class="text-xs font-medium text-slate-700 dark:text-slate-300">@Model.CourseCategoryName</span>
                                    </div>
                                </div>
                            </div>
                            
                            <a asp-action="Lessons" asp-route-courseId="@Model.CourseId" class="flex items-center justify-center gap-2 w-full py-3 rounded-lg border border-gray-200 dark:border-border-dark text-sm font-medium hover:bg-gray-50 dark:hover:bg-surface-dark transition-colors">
                                <span class="material-symbols-outlined text-[18px]">list</span>
                                Xem tất cả bài học
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Khoảng cách chân trang -->
                <div class="h-20"></div>
            </div>
        </main>
    </div>
    
    @* Script theo dõi tiến độ  *@
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const lessonId = @Model.LessonId;
        const lessonType = '@Model.LessonType';
        const isCompleted = @Model.IsCompleted.ToString().ToLower();
        const resumeTime = @(Model.CurrentTimeSeconds ?? 0);
        const resumePage = @(Model.CurrentPage ?? 1);
        const totalDuration = @(Model.TotalDurationSeconds ?? 0);
        const totalPages = @(Model.TotalPages ?? 1);

        let currentTime = resumeTime;
        let currentPage = resumePage;
        let trackingCompleted = isCompleted;

        // --- THEO DÕI VIDEO (YOUTUBE) ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
            if (document.getElementById('youtube-player')) {
                player = new YT.Player('youtube-player', {
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        function onPlayerReady(event) {
            if (resumeTime > 0) {
                event.target.seekTo(resumeTime);
            }
            startHeartbeat();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                // Video đang chạy
            } else if (event.data == YT.PlayerState.ENDED) {
                if (!trackingCompleted) {
                    markComplete();
                }
            }
        }

        // --- THEO DÕI VIDEO (HTML5) ---
        const html5Player = document.getElementById('html5-player');
        if (html5Player) {
            html5Player.currentTime = resumeTime;
            html5Player.addEventListener('ended', () => {
                if (!trackingCompleted) markComplete();
            });
            startHeartbeat();
        }

        // --- THEO DÕI PDF (CUSTOM VIEWER) ---
        let pdfDoc = null;
        let pdfScale = 1.2;
        const pdfContainer = document.getElementById('pdf-pages-list');
        const pdfScrollContainer = document.getElementById('pdf-scroll-container');

        if (lessonType === 'Pdf' && pdfContainer) {
            initLocalPdfViewer('@Model.ContentUrl');
        }

        async function initLocalPdfViewer(url) {
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                
                // Xóa loader
                const loader = document.getElementById('pdf-loader');
                if (loader) loader.remove();

                // Render tất cả các trang
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    await renderPdfPage(i);
                }

                // Cuộn đến trang cũ nếu có
                if (resumePage > 1) {
                    setTimeout(() => {
                        const targetPage = document.getElementById(`pdf-page-${resumePage}`);
                        if (targetPage) {
                            targetPage.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 1000);
                }

                updatePageIndicator(resumePage);

                // Lắng nghe sự kiện cuộn để cập nhật trang hiện tại
                pdfScrollContainer.addEventListener('scroll', throttle(() => {
                    const pages = document.querySelectorAll('.pdf-page-wrapper');
                    let currentInView = currentPage;
                    
                    const containerTop = pdfScrollContainer.getBoundingClientRect().top;
                    const containerMid = containerTop + (pdfScrollContainer.clientHeight / 2);

                    pages.forEach(p => {
                        const rect = p.getBoundingClientRect();
                        if (rect.top <= containerMid && rect.bottom >= containerMid) {
                            currentInView = parseInt(p.dataset.page);
                        }
                    });

                    if (currentInView !== currentPage) {
                        currentPage = currentInView;
                        updatePageIndicator(currentPage);
                        
                        if (currentPage >= pdfDoc.numPages && !trackingCompleted) {
                            markComplete();
                        }
                    }
                }, 100));

                startHeartbeat();
            } catch (error) {
                console.error('Error loading PDF:', error);
                pdfContainer.innerHTML = `<div class="text-red-400 p-10 text-center flex flex-col items-center gap-4">
                    <span class="material-symbols-outlined text-4xl">error</span>
                    <p>Không thể tải tệp PDF. Vui lòng kiểm tra lại đường dẫn.</p>
                    <a href="${url}" target="_blank" class="px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">Tải xuống thủ công</a>
                </div>`;
            }
        }

        async function renderPdfPage(num) {
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: pdfScale });
            
            const wrapper = document.createElement('div');
            wrapper.className = 'pdf-page-wrapper relative bg-white shadow-2xl ring-1 ring-black/10';
            wrapper.id = `pdf-page-${num}`;
            wrapper.dataset.page = num;
            
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-canvas';
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            wrapper.appendChild(canvas);
            pdfContainer.appendChild(wrapper);
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
        }

        function updatePageIndicator(num) {
            const indicator = document.getElementById('pdf-page-num');
            if (indicator && pdfDoc) {
                indicator.textContent = `Trang ${num} / ${pdfDoc.numPages}`;
            }
        }

        function changeZoom(delta) {
            pdfScale = Math.min(Math.max(0.5, pdfScale + delta), 3.0);
            document.getElementById('pdf-zoom').textContent = `${Math.round(pdfScale * 100)}%`;
            
            // Re-render
            const loader = document.createElement('div');
            loader.id = 'pdf-loader';
            loader.className = 'flex flex-col items-center gap-3 py-20 w-full';
            loader.innerHTML = '<div class="size-10 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div><p class="text-slate-400 text-sm">Đang tải lại...</p>';
            
            const prevScroll = pdfScrollContainer.scrollTop;
            pdfContainer.innerHTML = '';
            pdfContainer.appendChild(loader);

            async function refresh() {
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    await renderPdfPage(i);
                }
                loader.remove();
                pdfScrollContainer.scrollTop = prevScroll;
            }
            refresh();
        }

        // Hàm throttle để tối ưu hiệu suất cuộn
        function throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function() {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }

        // --- LOGIC ĐỒNG BỘ TIẾN ĐỘ ---
        function startHeartbeat() {
            setInterval(() => {
                syncProgress();
            }, 10000); // Mỗi 10 giây
        }

        function syncProgress() {
            if (trackingCompleted) return;

            let data = {
                lessonId: lessonId,
                isCompleted: trackingCompleted
            };

            if (lessonType === 'Video') {
                if (player && player.getCurrentTime) {
                    currentTime = Math.floor(player.getCurrentTime());
                } else if (html5Player) {
                    currentTime = Math.floor(html5Player.currentTime);
                }
                data.currentTime = currentTime;
            } else if (lessonType === 'Pdf') {
                data.currentPage = currentPage;
            }

            $.ajax({
                url: '@Url.Action("SaveProgress", "Learning")',
                type: 'POST',
                data: data,
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                }
            });
        }

        function markComplete() {
            trackingCompleted = true;
            syncProgress();
            
            // Reload page hoặc thông báo hoàn thành
            if (window.showConfirmDialog) {
                showConfirmDialog(null, 'Chúc mừng!', 'Bạn đã hoàn thành bài học này.', 'Tiếp tục', 'success', () => {
                    location.reload();
                });
            } else {
                if(confirm('Bạn đã hoàn thành bài học! Nhấn OK để tải lại trang.')) {
                    location.reload();
                }
            }
        }

        // Lưu trước khi thoát
        window.addEventListener('beforeunload', syncProgress);

        function showLockAlert() {
            if(window.showConfirmDialog) {
                showConfirmDialog(null, 'Bài học bị khóa', 'Bạn cần hoàn thành bài học trước đó để có thể mở khóa bài học này.', 'Đã hiểu', 'info');
            } else {
                alert('Bài học này đang bị khóa. Bạn cần hoàn thành các bài học trước đó.');
            }
        }
    </script>
</body>
</html>
