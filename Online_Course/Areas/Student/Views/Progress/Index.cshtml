@model Online_Course.ViewModels.StudentProgressIndexViewModel
@using Online_Course.Models
@{
    ViewData["Title"] = "Tiến độ học tập";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
}

@* CSS cho Tab và Hiển thị *@
<style>
    .tab-btn.active {
        background-color: #3b82f6;
        color: white;
        box-shadow: 0 4px 6px -1px rgb(59 130 246 / 0.2);
    }
    .course-item.hidden {
        display: none !important;
    }
</style>

<div class="relative flex h-full w-full flex-row overflow-hidden bg-[#f9fafb] dark:bg-[#0f172a]">
    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-y-auto">
        <!-- Header - Thu gọn padding -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 px-6 py-5 border-b border-gray-200 dark:border-slate-800 bg-white dark:bg-[#1e252b]">
            <div class="flex flex-col">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white">Tiến độ học tập</h1>
                <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400">Tổng quan quá trình học tập của bạn</p>
            </div>
        </div>

        <div class="px-6 py-6 max-w-[1280px] mx-auto w-full flex flex-col gap-6">
            <!-- Stats Row - Thu gọn khoảng cách -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex flex-col gap-1 rounded-xl p-5 bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 shadow-sm transition-all hover:shadow-md">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400">
                            <span class="material-symbols-outlined text-[20px] fill">school</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Tổng khóa học</p>
                    </div>
                    <p class="text-2xl font-black text-slate-900 dark:text-white pl-1">@Model.TotalCourses</p>
                </div>
                <div class="flex flex-col gap-1 rounded-xl p-5 bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 shadow-sm transition-all hover:shadow-md">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="p-2 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400">
                            <span class="material-symbols-outlined text-[20px] fill">check_circle</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Đã hoàn thành</p>
                    </div>
                    <p class="text-2xl font-black text-slate-900 dark:text-white pl-1">@Model.CompletedCourses</p>
                </div>
                <div class="flex flex-col gap-1 rounded-xl p-5 bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 shadow-sm transition-all hover:shadow-md">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400">
                            <span class="material-symbols-outlined text-[20px] fill">trending_up</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Tiến độ trung bình</p>
                    </div>
                    <p class="text-2xl font-black text-slate-900 dark:text-white pl-1">@Model.OverallProgress%</p>
                </div>
            </section>

            <!-- Main Content Grid - Thu gọn gap -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <!-- Overall Progress Card -->
                    <div class="rounded-xl bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 p-5 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-base font-bold text-slate-900 dark:text-white">Tiến độ tổng thể</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Dựa trên tất cả các khóa học</p>
                            </div>
                            @{
                                var progressLabel = Model.OverallProgress >= 80 ? "Rất tốt!" : 
                                                   Model.OverallProgress >= 50 ? "Tốt!" : 
                                                   Model.OverallProgress >= 25 ? "Cố gắng!" : "Bắt đầu!";
                                var progressColor = Model.OverallProgress >= 80 ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400" : 
                                                   Model.OverallProgress >= 50 ? "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400" : 
                                                   Model.OverallProgress >= 25 ? "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400" : "bg-gray-100 text-gray-700";
                            }
                            <span class="px-2.5 py-1 rounded-md @progressColor text-[10px] font-black uppercase tracking-widest">@progressLabel</span>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="flex justify-between items-baseline">
                                <span class="text-3xl font-black text-primary">@Model.OverallProgress%</span>
                                <span class="text-xs font-medium text-slate-500 dark:text-slate-400">@Model.CompletedCourses / @Model.TotalCourses hoàn thành</span>
                            </div>
                            <div class="h-3 w-full rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
                                <div class="h-full rounded-full bg-primary transition-all duration-700 ease-out" style="width: @Model.OverallProgress%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs Container - Hiện đại hơn, bỏ tiêu đề theo yêu cầu -->
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-start items-center">
                            <!-- Tabs Phân Loại - Pill Style -->
                            <div class="flex bg-white dark:bg-[#1e252b] p-1.5 rounded-xl border border-gray-100 dark:border-slate-800 shadow-sm gap-1">
                                <button onclick="filterCourses('all', this)" class="tab-btn active px-4 py-2 text-xs font-bold rounded-lg transition-all flex items-center gap-2">
                                    Tất cả
                                    <span class="opacity-70 text-[10px]">@Model.Courses.Count</span>
                                </button>
                                <button onclick="filterCourses('NOT_STARTED', this)" class="tab-btn px-4 py-2 text-xs font-bold text-slate-500 dark:text-slate-400 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800/50 flex items-center gap-2">
                                    Chưa học
                                    <span class="opacity-70 text-[10px]">@Model.Courses.Count(c => c.LearningStatus == LearningStatus.NOT_STARTED)</span>
                                </button>
                                <button onclick="filterCourses('IN_PROGRESS', this)" class="tab-btn px-4 py-2 text-xs font-bold text-slate-500 dark:text-slate-400 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800/50 flex items-center gap-2">
                                    Đang học
                                    <span class="opacity-70 text-[10px]">@Model.Courses.Count(c => c.LearningStatus == LearningStatus.IN_PROGRESS)</span>
                                </button>
                                <button onclick="filterCourses('COMPLETED', this)" class="tab-btn px-4 py-2 text-xs font-bold text-slate-500 dark:text-slate-400 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800/50 flex items-center gap-2">
                                    Hoàn thành
                                    <span class="opacity-70 text-[10px]">@Model.Courses.Count(c => c.LearningStatus == LearningStatus.COMPLETED)</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="course-container" class="flex flex-col gap-4">
                            @if (Model.Courses.Count == 0)
                            {
                                <div class="flex flex-col items-center justify-center p-12 rounded-xl bg-white dark:bg-[#1e252b] border border-dashed border-gray-200 dark:border-slate-800">
                                    <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">school</span>
                                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">Bạn chưa đăng ký khóa học nào</p>
                                    <a asp-area="Student" asp-controller="Courses" asp-action="Index" class="px-5 py-2.5 bg-primary hover:bg-blue-600 text-white text-xs font-bold rounded-lg transition-all shadow-md active:scale-95">
                                        Khám phá ngay
                                    </a>
                                </div>
                            }
                            else
                            {
                                @foreach (var course in Model.Courses)
                                {
                                    <div class="course-item flex flex-col md:flex-row gap-4 p-4 rounded-xl bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 hover:border-primary/50 transition-all shadow-sm relative group" 
                                         data-status="@course.LearningStatus">
                                        
                                        <!-- Thumbnail -->
                                        <div class="w-full md:w-52 h-36 md:h-auto rounded-lg bg-cover bg-center shrink-0 bg-slate-50 overflow-hidden relative" 
                                             style="@(string.IsNullOrEmpty(course.ThumbnailUrl) ? "" : $"background-image: url('{course.ThumbnailUrl}');")">
                                            @if (string.IsNullOrEmpty(course.ThumbnailUrl))
                                            {
                                                <div class="w-full h-full flex items-center justify-center">
                                                    <span class="material-symbols-outlined text-4xl text-slate-200">image</span>
                                                </div>
                                            }
                                            @if (course.IsMandatory)
                                            {
                                                <div class="absolute top-2 left-2 px-2 py-0.5 bg-red-600 text-white text-[9px] font-black uppercase tracking-tighter rounded shadow-sm">Bắt buộc</div>
                                            }
                                        </div>

                                        <div class="flex flex-col flex-1 justify-between py-0.5">
                                            <div>
                                                <div class="flex justify-between items-start mb-1">
                                                    <span class="text-[10px] font-black uppercase tracking-widest text-primary/80">@course.CategoryName</span>
                                                    <span class="text-[10px] font-medium text-slate-400 italic">@course.EnrolledAt.ToString("dd/MM/yyyy")</span>
                                                </div>
                                                <h4 class="text-lg font-bold text-slate-900 dark:text-white leading-tight group-hover:text-primary transition-colors">@course.Title</h4>
                                                
                                                @if (course.LearningStatus == LearningStatus.COMPLETED)
                                                {
                                                    <div class="flex items-center gap-1.5 text-green-500 text-xs mt-1.5 font-bold">
                                                        <span class="material-symbols-outlined text-sm fill">verified</span>
                                                        Đã hoàn thành xuất sắc!
                                                    </div>
                                                }
                                                else if (!string.IsNullOrEmpty(course.CurrentLessonTitle))
                                                {
                                                    <div class="flex items-center gap-1.5 text-slate-500 text-xs mt-1.5">
                                                        <span class="material-symbols-outlined text-sm">play_circle</span>
                                                        <span class="italic">Đang học: @course.CurrentLessonTitle</span>
                                                    </div>
                                                }
                                            </div>

                                            <div class="flex flex-col gap-2 mt-4">
                                                <div class="flex justify-between text-[11px] font-bold text-slate-700 dark:text-slate-300 uppercase tracking-tighter">
                                                    <div class="flex items-center gap-1">
                                                        <span class="material-symbols-outlined text-[14px]">auto_stories</span>
                                                        Tiến độ (@course.CompletedLessons/@course.TotalLessons bài)
                                                    </div>
                                                    <span class="text-primary font-black">@Math.Round(course.ProgressPercentage)%</span>
                                                </div>
                                                <div class="h-1.5 w-full rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
                                                    @{
                                                        var barColor = course.ProgressPercentage >= 100 ? "bg-green-500" : "bg-primary";
                                                    }
                                                    <div class="h-full rounded-full @barColor transition-all duration-700 ease-out" style="width: @course.ProgressPercentage%"></div>
                                                </div>

                                                <div class="flex justify-end mt-2 gap-3">
                                                    @* Hủy đăng ký *@
                                                    @if (course.LearningStatus == LearningStatus.NOT_STARTED && !course.IsMandatory)
                                                    {
                                                        <form asp-area="Student" asp-controller="Courses" asp-action="Unenroll" method="post" class="inline delete-form">
                                                            <input type="hidden" name="courseId" value="@course.CourseId" />
                                                            <button type="button" onclick="showConfirmDialog(this.closest('form'), 'Hủy đăng ký', 'Bạn có chắc muốn hủy khóa học này?', 'Hủy đăng ký', 'danger')" 
                                                                    class="px-4 py-2 hover:bg-red-50 text-red-500 text-xs font-bold rounded-lg transition-all flex items-center gap-1.5">
                                                                <span class="material-symbols-outlined text-sm">cancel</span>
                                                                Hủy học
                                                            </button>
                                                        </form>
                                                    }

                                                    @if (course.LearningStatus == LearningStatus.COMPLETED)
                                                    {
                                                        <a asp-area="Student" asp-controller="Learning" asp-action="Lessons" asp-route-courseId="@course.CourseId" 
                                                           class="px-5 py-2 bg-green-500 hover:bg-green-600 text-white text-xs font-bold rounded-xl transition-all shadow-sm flex items-center gap-1.5 active:scale-95">
                                                            <span class="material-symbols-outlined text-sm">history</span>
                                                            Xem lại bài học
                                                        </a>
                                                    }
                                                    else if(course.LearningStatus == LearningStatus.NOT_STARTED)
                                                    {
                                                        <a asp-area="Student" asp-controller="Learning" asp-action="Lessons" asp-route-courseId="@course.CourseId"
                                                           class="px-5 py-2 bg-primary hover:bg-green-600 text-white text-xs font-bold rounded-xl transition-all shadow-md flex items-center gap-1.5 active:scale-95">
                                                            <span class="material-symbols-outlined text-sm">play_arrow</span>
                                                            Bắt đầu ngay
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <a asp-area="Student" asp-controller="Learning" asp-action="Lessons" asp-route-courseId="@course.CourseId" 
                                                           class="px-5 py-2 bg-primary hover:bg-blue-600 text-white text-xs font-bold rounded-xl transition-all shadow-md flex items-center gap-1.5 active:scale-95">
                                                            <span class="material-symbols-outlined text-sm">play_arrow</span>
                                                            Tiếp tục ngay
                                                        </a>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Right Column - Sidebar thu gọn gap -->
                <div class="flex flex-col gap-6">
                    <!-- Progress Summary Card -->
                    <div class="rounded-xl bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 p-5 shadow-sm">
                        <div class="flex flex-col mb-4">
                            <h3 class="text-base font-bold text-slate-900 dark:text-white">Tóm tắt tiến độ</h3>
                            <p class="text-[11px] text-slate-500 dark:text-slate-400">Chi tiết theo danh mục</p>
                        </div>
                        <div class="flex flex-col gap-3">
                            @{
                                var inProgressCount = Model.Courses.Count(c => c.LearningStatus != LearningStatus.COMPLETED);
                                var completedCount = Model.Courses.Count(c => c.LearningStatus == LearningStatus.COMPLETED);
                                var totalLessons = Model.Courses.Sum(c => c.TotalLessons);
                                var completedLessons = Model.Courses.Sum(c => c.CompletedLessons);
                            }
                            
                            <div class="flex gap-3 items-center p-3 rounded-xl bg-slate-50 dark:bg-slate-800/40 border border-slate-100/50 dark:border-slate-700/50">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[18px]">update</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-[11px] font-black text-slate-500 uppercase tracking-tighter">Đang học</p>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">@inProgressCount khóa học</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-3 items-center p-3 rounded-xl bg-slate-50 dark:bg-slate-800/40 border border-slate-100/50 dark:border-slate-700/50">
                                <div class="w-8 h-8 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[18px] fill">check_circle</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-[11px] font-black text-slate-500 uppercase tracking-tighter">Hoàn thành</p>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">@completedCount khóa học</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-3 items-center p-3 rounded-xl bg-slate-50 dark:bg-slate-800/40 border border-slate-100/50 dark:border-slate-700/50">
                                <div class="w-8 h-8 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[18px]">menu_book</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-[11px] font-black text-slate-500 uppercase tracking-tighter">Bài học</p>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">@completedLessons / @totalLessons bài</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Motivation Quote - Modernize -->
                    <div class="rounded-xl bg-gradient-to-br from-primary/10 to-transparent p-5 border border-primary/20 relative overflow-hidden group">
                        <div class="absolute -right-2 -bottom-2 opacity-[0.05] group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-6xl">format_quote</span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <span class="material-symbols-outlined text-primary text-xl">format_quote</span>
                        </div>
                        <p class="text-xs font-bold text-slate-800 dark:text-slate-200 leading-relaxed italic pr-4">
                            "Sự kiên trì là chìa khóa của thành công. Đừng bỏ cuộc ngay cả khi bạn gặp khó khăn."
                        </p>
                    </div>

                    <!-- Quick Actions - Thu gọn -->
                    <div class="rounded-xl bg-white dark:bg-[#1e252b] border border-gray-100 dark:border-slate-800 p-5 shadow-sm">
                        <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-3 uppercase tracking-wider">Hành động nhanh</h3>
                        <div class="flex flex-col gap-2">
                            <a asp-area="Student" asp-controller="Courses" asp-action="Index" 
                               class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800/40 hover:bg-primary/10 hover:text-primary transition-all group">
                                <span class="material-symbols-outlined text-primary group-hover:scale-110 transition-transform">explore</span>
                                <span class="text-xs font-bold">Khám phá khóa học mới</span>
                            </a>
                            <a asp-area="Student" asp-controller="Progress" asp-action="Index" 
                               class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800/40 hover:bg-primary/10 hover:text-primary transition-all group">
                                <span class="material-symbols-outlined text-primary group-hover:scale-110 transition-transform">auto_stories</span>
                                <span class="text-xs font-bold">Tiếp tục hành trình</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

@* JS Xử lý lọc *@
<script>
    function filterCourses(status, btn) {
        // Cập nhật nút active
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'font-bold', 'bg-white', 'dark:bg-[#1e252b]', 'shadow-sm');
            b.classList.add('text-slate-500', 'dark:text-slate-400');
            b.classList.remove('text-white');
        });
        
        btn.classList.add('active', 'font-bold');
        btn.classList.remove('text-slate-500', 'dark:text-slate-400');

        // Lọc item
        const items = document.querySelectorAll('.course-item');
        items.forEach(item => {
            if (status === 'all' || item.getAttribute('data-status') === status) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }
</script>
