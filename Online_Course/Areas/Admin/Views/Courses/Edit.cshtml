@model Online_Course.ViewModels.EditCourseViewModel
@{
    ViewData["Title"] = "Chỉnh sửa khóa học";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="max-w-10xl mx-auto">
    <!-- Page Header -->
    <div class="flex items-center gap-4 mb-6">
        <a asp-action="Index" class="p-2 text-gray-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <div>
            <h1 class="text-slate-900 dark:text-white text-2xl font-bold">Chỉnh sửa khóa học</h1>
            <p class="text-gray-500 dark:text-slate-400 text-sm">Cập nhật thông tin chi tiết của khóa học</p>
        </div>
    </div>

    <!-- Form Card -->
    <div class="bg-white dark:bg-[#1a222c] border border-gray-200 dark:border-[#283039] rounded-xl p-6 lg:p-8">
        <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editCourseForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="CourseId" />

            <!-- Validation Summary -->
            <div asp-validation-summary="ModelOnly" class="text-red-500 dark:text-red-400 text-sm mb-4"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-5">
                    <!-- Title -->
                    <div>
                        <label asp-for="Title" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Tiêu đề khóa học <span class="text-red-500">*</span></label>
                        <input asp-for="Title" class="w-full h-12 px-4 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white placeholder-gray-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-primary transition-colors" />
                        <span asp-validation-for="Title" class="text-red-500 dark:text-red-400 text-sm mt-1"></span>
                    </div>

                    <!-- Description -->
                    <div>
                        <label asp-for="Description" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Mô tả chi tiết</label>
                        <textarea asp-for="Description" rows="5" class="w-full px-4 py-3 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white placeholder-gray-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-primary transition-colors resize-none"></textarea>
                        <span asp-validation-for="Description" class="text-red-500 dark:text-red-400 text-sm mt-1"></span>
                    </div>

                    <!-- Category and Instructor in row -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Category -->
                        <div>
                            <label asp-for="CategoryId" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Danh mục</label>
                            <select asp-for="CategoryId" asp-items="ViewBag.CategoriesList" class="w-full h-12 px-4 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors cursor-pointer">
                                <option value="">Chọn danh mục</option>
                            </select>
                            <span asp-validation-for="CategoryId" class="text-red-500 dark:text-red-400 text-sm mt-1"></span>
                        </div>

                        <!-- Instructor -->
                        <div>
                            <label asp-for="InstructorId" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Giảng viên <span class="text-red-500">*</span></label>
                            <select asp-for="InstructorId" asp-items="ViewBag.Instructors" class="w-full h-12 px-4 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors cursor-pointer">
                                <option value="">Chọn giảng viên</option>
                            </select>
                            <span asp-validation-for="InstructorId" class="text-red-500 dark:text-red-400 text-sm mt-1"></span>
                        </div>
                    </div>

                    <!-- Status and Course Type in row -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Status -->
                        <div>
                            <label asp-for="Status" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Trạng thái</label>
                            <select asp-for="Status" id="statusSelect" class="w-full h-12 px-4 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors cursor-pointer">
                                <option value="@Online_Course.Models.CourseStatus.Draft">Nháp</option>
                                <option value="@Online_Course.Models.CourseStatus.Private">Riêng tư</option>
                                <option value="@Online_Course.Models.CourseStatus.Public">Công khai</option>
                                <option value="@Online_Course.Models.CourseStatus.Closed">Đã đóng</option>
                            </select>
                        </div>

                        <!-- Course Type -->
                        <div>
                            <label asp-for="CourseType" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Loại khóa học</label>
                            <select asp-for="CourseType" id="courseTypeSelect" class="w-full h-12 px-4 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors cursor-pointer">
                                <option value="@Online_Course.Models.CourseType.Open_Always">Mở xuyên suốt</option>
                                <option value="@Online_Course.Models.CourseType.Fixed_Time">Thời gian cố định</option>
                            </select>
                        </div>
                    </div>

                    <!-- Lựa chọn học viên cho khóa học Riêng tư -->
                    <div id="studentSelectionSection" class="hidden space-y-4 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-amber-500">group</span>
                            Chọn học viên cho khóa học riêng tư
                        </h3>
                        <p class="text-xs text-gray-500 dark:text-slate-400 mb-3">
                            Học viên được chọn sẽ tự động được ghi danh vào khóa học này.
                        </p>

                        <!-- Ô tìm kiếm học viên -->
                        <div class="mb-3 relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <span class="material-symbols-outlined text-[20px]">search</span>
                            </span>
                            <input type="text" id="studentSearch" placeholder="Tìm kiếm tên hoặc email..." 
                                   class="w-full h-10 pl-10 pr-4 text-sm bg-white dark:bg-[#111418] border border-gray-200 dark:border-[#283039] rounded-lg focus:ring-1 focus:ring-primary focus:border-primary transition-all outline-none text-slate-900 dark:text-white" />
                        </div>
                        
                        <div id="studentListContainer" class="max-h-60 overflow-y-auto border border-gray-200 dark:border-[#283039] rounded-lg bg-white dark:bg-[#111418] p-2">
                            @if (ViewBag.Students != null)
                            {
                                foreach (var student in (IEnumerable<Online_Course.Models.User>)ViewBag.Students)
                                {
                                    <div class="student-item flex items-center p-2 hover:bg-gray-50 dark:hover:bg-[#202934] rounded transition-colors">
                                        <input type="checkbox" name="SelectedStudentIds" value="@student.UserId" id="student_@student.UserId" 
                                               class="student-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2 dark:ring-offset-gray-800 focus:ring-offset-2 dark:bg-slate-700 dark:border-slate-600"
                                               @(Model.SelectedStudentIds != null && Model.SelectedStudentIds.Contains(student.UserId) ? "checked" : "") />
                                        <label for="student_@student.UserId" class="ml-3 text-sm font-medium text-slate-900 dark:text-white cursor-pointer flex-1">
                                            <div class="student-name font-bold">@student.FullName</div>
                                            <div class="student-email text-xs text-gray-400">@student.Email</div>
                                        </label>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-sm text-gray-500 p-4 text-center">Không tìm thấy học viên nào.</p>
                            }
                        </div>
                    </div>

                    <!-- Date Fields (shown only for Fixed_Time) -->
                    <div id="dateFieldsSection" class="@(Model.CourseType == Online_Course.Models.CourseType.Fixed_Time ? "" : "hidden") space-y-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">calendar_month</span>
                            Thời gian khóa học
                        </h3>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Registration Start Date -->
                            <div>
                                <label asp-for="RegistrationStartDate" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Bắt đầu đăng ký</label>
                                <input asp-for="RegistrationStartDate" type="date" class="w-full h-12 px-4 bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors" />
                            </div>

                            <!-- Registration End Date -->
                            <div>
                                <label asp-for="RegistrationEndDate" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Kết thúc đăng ký</label>
                                <input asp-for="RegistrationEndDate" type="date" class="w-full h-12 px-4 bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors" />
                            </div>

                            <!-- Start Date -->
                            <div>
                                <label asp-for="StartDate" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Ngày khai giảng</label>
                                <input asp-for="StartDate" type="date" class="w-full h-12 px-4 bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors" />
                            </div>

                            <!-- End Date -->
                            <div>
                                <label asp-for="EndDate" class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Ngày kết thúc</label>
                                <input asp-for="EndDate" type="date" class="w-full h-12 px-4 bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-colors" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Thumbnail -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-slate-900 dark:text-white">Ảnh bìa khóa học</label>

                    <!-- Tab buttons -->
                    <div class="flex gap-2">
                        <button type="button" id="tab-upload" onclick="switchTab('upload')" class="px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white transition-colors">
                            <span class="material-symbols-outlined text-sm align-middle mr-1">upload</span>
                            Tải lên mới
                        </button>
                        <button type="button" id="tab-url" onclick="switchTab('url')" class="px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-[#283039] text-gray-700 dark:text-slate-300 hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors">
                            <span class="material-symbols-outlined text-sm align-middle mr-1">link</span>
                            Sử dụng URL
                        </button>
                    </div>

                    <!-- Upload file -->
                    <div id="panel-upload" class="block">
                        <div id="upload-zone" class="border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl p-8 text-center hover:border-primary hover:bg-primary/5 transition-all cursor-pointer" onclick="document.getElementById('thumbnailFile').click()">
                            <input type="file" name="thumbnailFile" id="thumbnailFile" accept="image/*" class="hidden" onchange="previewImage(this)" />

                            <div id="upload-placeholder" class="@(!string.IsNullOrEmpty(Model.ThumbnailUrl) ? "hidden" : "")">
                                <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-slate-500 mb-3 block">cloud_upload</span>
                                <p class="text-gray-600 dark:text-slate-300 text-sm font-medium">Thay đổi ảnh bìa</p>
                            </div>

                            <div id="file-selected" class="@(string.IsNullOrEmpty(Model.ThumbnailUrl) ? "hidden" : "")">
                                <img id="image-preview" src="@Model.ThumbnailUrl" class="mx-auto max-h-48 rounded-lg mb-3 shadow-md object-cover" />
                                <p id="file-name" class="text-gray-600 dark:text-slate-300 text-sm font-medium truncate"></p>
                                <button type="button" onclick="removeImage(event)" class="mt-3 px-4 py-2 text-sm font-medium text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-sm align-middle mr-1">delete</span>
                                    Xóa ảnh này
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- URL input -->
                    <div id="panel-url" class="hidden">
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">
                                <span class="material-symbols-outlined text-[20px]">link</span>
                            </span>
                            <input asp-for="ThumbnailUrl" class="w-full h-12 pl-12 pr-4 bg-gray-50 dark:bg-[#111418] border border-gray-300 dark:border-[#283039] rounded-lg text-slate-900 dark:text-white placeholder-gray-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="https://example.com/image.jpg" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex items-center gap-4 pt-6 mt-6 border-t border-gray-200 dark:border-[#283039]">
                <button type="submit" class="flex-1 sm:flex-none sm:min-w-[200px] h-12 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-[20px]">save</span>
                    Lưu thay đổi
                </button>
                <a asp-action="Index" class="flex-1 sm:flex-none sm:min-w-[120px] h-12 bg-gray-200 dark:bg-[#283039] hover:bg-gray-300 dark:hover:bg-slate-700 text-slate-900 dark:text-white font-medium rounded-lg transition-colors flex items-center justify-center">
                    Hủy bỏ
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let currentMode = 'upload';

        function toggleDateFields() {
            const courseTypeSelect = document.getElementById('courseTypeSelect');
            const dateFieldsSection = document.getElementById('dateFieldsSection');

            if (courseTypeSelect.value === 'Fixed_Time' || courseTypeSelect.value === '@((int)Online_Course.Models.CourseType.Fixed_Time)') {
                dateFieldsSection.classList.remove('hidden');
            } else {
                dateFieldsSection.classList.add('hidden');
                document.querySelectorAll('#dateFieldsSection input').forEach(input => input.value = '');
            }
        }

        function switchTab(tab) {
            currentMode = tab;
            const tabUpload = document.getElementById('tab-upload');
            const tabUrl = document.getElementById('tab-url');
            const panelUpload = document.getElementById('panel-upload');
            const panelUrl = document.getElementById('panel-url');

            if (tab === 'upload') {
                tabUpload.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white transition-colors';
                tabUrl.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-[#283039] text-gray-700 dark:text-slate-300 hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors';
                panelUpload.classList.remove('hidden');
                panelUrl.classList.add('hidden');
            } else {
                tabUrl.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white transition-colors';
                tabUpload.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-[#283039] text-gray-700 dark:text-slate-300 hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors';
                panelUrl.classList.remove('hidden');
                panelUpload.classList.add('hidden');
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('upload-placeholder');
            const fileSelected = document.getElementById('file-selected');
            const fileName = document.getElementById('file-name');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    fileName.textContent = file.name;
                    placeholder.classList.add('hidden');
                    fileSelected.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(event) {
            event.stopPropagation();
            const input = document.getElementById('thumbnailFile');
            input.value = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('file-selected').classList.add('hidden');
            document.getElementById('image-preview').src = '';
        }

        document.getElementById('courseTypeSelect').addEventListener('change', toggleDateFields);

        // Student Selection toggle functionality
        const statusSelect = document.getElementById('statusSelect');
        const studentSection = document.getElementById('studentSelectionSection');
        
        function toggleStudentSelection() {
            const val = statusSelect.value;
            if (val === 'Private' || val === '@((int)Online_Course.Models.CourseStatus.Private)' || val === '1') {
                studentSection.classList.remove('hidden');
            } else {
                studentSection.classList.add('hidden');
            }
        }

        if (statusSelect) {
            statusSelect.addEventListener('change', toggleStudentSelection);
        }

        // Student Search functionality
        const studentSearchInput = document.getElementById('studentSearch');
        const studentItems = document.querySelectorAll('.student-item');

        function removeVietnameseTones(str) {
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"); 
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"); 
            str = str.replace(/ì|í|ị|ỉ|ĩ/g,"i"); 
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"); 
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"); 
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"); 
            str = str.replace(/đ/g,"d");
            str = str.replace(/À|À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g,"A");
            str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g,"E");
            str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g,"I");
            str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g,"O");
            str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g,"U");
            str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g,"Y");
            str = str.replace(/Đ/g,"D");
            str = str.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g, ""); 
            str = str.replace(/\u02C6|\u0306|\u031B/g, ""); 
            return str;
        }

        if (studentSearchInput) {
            studentSearchInput.addEventListener('input', function() {
                const query = removeVietnameseTones(this.value.toLowerCase().trim());
                studentItems.forEach(item => {
                    const name = removeVietnameseTones(item.querySelector('.student-name').textContent.toLowerCase());
                    const email = removeVietnameseTones(item.querySelector('.student-email').textContent.toLowerCase());
                    
                    if (name.includes(query) || email.includes(query)) {
                        item.classList.remove('hidden');
                        item.classList.add('flex');
                    } else {
                        item.classList.add('hidden');
                        item.classList.remove('flex');
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            toggleDateFields();
            toggleStudentSelection();
        });
    </script>
}
